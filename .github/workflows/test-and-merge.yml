name: Test and Merge

on:
  push:
    branches:
      - dev  # Запускать при пуше в ветку dev

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Start Forge Test Server
        run: |
          docker run -d --name test-server \
            -v ${{ github.workspace }}/mods:/data/mods \
            -v ${{ github.workspace }}/config:/data/config \
            -e EULA=TRUE -e TYPE=FORGE -p 25566:25565 \
            itzg/minecraft-server:latest
          sleep 60  # Ждём, пока сервер полностью запустится

      - name: Verify Server is Running
        run: |
          curl --fail http://localhost:25566 || exit 1

  merge:
    needs: test
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Merge dev into main
        run: |
          git checkout main
          git merge dev --no-ff
          git push origin main