name: Test and Merge
# Lets fucking go
on:
  push:
    branches:
      - dev  # Запускать при пуше в ветку dev

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

        
      - name: Start Forge Test Server
        run: |
          docker run -d --name test-server \
            -v $PWD/mods:/data/mods \
            -e EULA=TRUE \
            -e TYPE=FORGE \
            -e VERSION=1.20.1 \
            -e FORGEVERSION=47.3.22 \
            -e JVM_OPTS="-Xmx6G -Xms1G" \
            -p 25566:25565 \
            itzg/minecraft-server:latest
          sleep 900
        
      - name: Check Docker Logs
        run: docker logs test-server
      
      - name: Verify Port Accessibility
        run: nc -zv localhost 25566 || exit 1

      - name: Install mcstatus
        run: |
          pip install mcstatus
      - name: Verify Server is Running
        run: |
          mcstatus localhost:25566 ping || exit 1
  merge:
    needs: test
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
  
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
  
      - name: Sync mods folder to Main Branch
        run: |
          # Клонируем репозиторий и переключаемся на ветку main
          git clone https://${{ secrets.PAT }}@github.com/cofedish/cofemine-sborka.git main-repo
          cd main-repo
          git checkout main
      
          # Создаем или обновляем папку mods
          mkdir -p mods
          # Копируем серверные моды из текущей репозитории в mods
          cp -r ../mods/* mods/ || true
      
          # Проверяем статус и добавляем изменения
          git status
          git add mods
          git commit --allow-empty -m "Update mods folder with latest changes"
      
          # Задаем URL для аутентификации с токеном
          git remote set-url origin https://${{ secrets.PAT }}@github.com/cofedish/cofemine-sborka.git
      
          # Пушим изменения в ветку main
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

          
      - name: Sync mods to Client Repository
        run: |
          # Клонируем клиентский репозиторий
          git clone https://${{ secrets.PAT }}@github.com/cofedish/cofemine-sborka-client.git client-repo
          cd client-repo
          # Создаем итоговую папку mods
          mkdir -p mods
          # Копируем клиентские моды в mods
          cp -r client-mods/* mods/ || true
          # Копируем серверные моды из текущей репозитории в mods
          cp -r ../mods/* mods/ || true
          # Добавляем и коммитим изменения
          git add mods
          git commit --allow-empty -m "Update mods with latest server and client mods"
          # Задаем URL для аутентификации с токеном
          git remote set-url origin https://${{ secrets.PAT }}@github.com/cofedish/cofemine-sborka-client.git
          # Пушим изменения в клиентский репозиторий
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

